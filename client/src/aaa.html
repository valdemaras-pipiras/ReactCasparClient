<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/6.0.0-rc.1/fabric.min.js"
        integrity="sha512-P6uimDKoj1nnPSo2sPmgbZy99pPq9nHXhLwddOnLi1DC+fEM83FEUcHPRPifbx1rlRkdMinViaWyDfG45G9BuA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body style="overflow:hidden">
    <script>


        const updatestring = (str1, str2) => {
            const idTemplate = canvas.getObjects().filter(function (element) {
                return element.id === str1;
            });
            idTemplate[0].set({ text: str2 })
            canvas.requestRenderAll();
        }
        const updateimage = (str1, base64data) => {
            const idTemplate = canvas.getObjects().filter(function (element) {
                return element.id === str1;
            });
            //   idTemplate[0].set({preserveAspectRatio: 'none'});
            //   idTemplate[0].setPreserveAspectRatio('none');

            idTemplate[0].setSrc(base64data, function () {
                idTemplate[0].set({ preserveAspectRatio: 'none' });
                idTemplate[0].setPreserveAspectRatio('none');
                canvas.requestRenderAll();
            });

        }
    </script>
    <canvas id="canvas" width="1920" height="1080"></canvas>
    <script type="module">
        const hexToRGB = hex => {
            const red = parseInt(hex.slice(1, 3), 16)
            const green = parseInt(hex.slice(3, 5), 16)
            const blue = parseInt(hex.slice(5, 7), 16)
            return { r: red / 255, g: green / 255, b: blue / 255, a: 1 } // return an object
            // return [ r, g, b ]
        }
        const shadowOptions = {
            color: 'black',
            blur: 30,
            offsetX: 0,
            offsetY: 0,
            affectStroke: false
        };
        var canvas = new fabric.Canvas('canvas');
        window.canvas = canvas;
        canvas.preserveObjectStacking = true;
        const content = { "version": "5.2.4", "objects": [{ "type": "polygon", "version": "5.2.4", "originX": "left", "originY": "top", "left": 80, "top": 330, "width": 198, "height": 173, "fill": "#0000ff", "stroke": "#ffffff", "strokeWidth": 3, "strokeDashArray": null, "strokeLineCap": "butt", "strokeDashOffset": 0, "strokeLineJoin": "miter", "strokeUniform": true, "strokeMiterLimit": 4, "scaleX": 1, "scaleY": 1, "angle": 0, "flipX": false, "flipY": false, "opacity": 0.9, "shadow": { "color": "black", "blur": 30, "offsetX": 0, "offsetY": 0, "affectStroke": false, "nonScaling": false }, "visible": true, "backgroundColor": "", "fillRule": "nonzero", "paintFirst": "fill", "globalCompositeOperation": "source-over", "skewX": 0, "skewY": 0, "id": "ccg_6", "class": "class_6", "selectable": true, "points": [{ "x": 290, "y": 124 }, { "x": 390, "y": 190 }, { "x": 354, "y": 297 }, { "x": 226, "y": 297 }, { "x": 192, "y": 190 }] }, { "type": "triangle", "version": "5.2.4", "originX": "left", "originY": "top", "left": 150, "top": 50, "width": 100, "height": 100, "fill": "#ff00ff", "stroke": "#ffffff", "strokeWidth": 3, "strokeDashArray": null, "strokeLineCap": "butt", "strokeDashOffset": 0, "strokeLineJoin": "miter", "strokeUniform": true, "strokeMiterLimit": 4, "scaleX": 1, "scaleY": 1, "angle": 0, "flipX": false, "flipY": false, "opacity": 1, "shadow": { "color": "black", "blur": 30, "offsetX": 0, "offsetY": 0, "affectStroke": false, "nonScaling": false }, "visible": true, "backgroundColor": "", "fillRule": "nonzero", "paintFirst": "fill", "globalCompositeOperation": "source-over", "skewX": 0, "skewY": 0, "id": "ccg_7", "class": "class_7", "selectable": true }] };

        import 'https://cdn.jsdelivr.net/npm/@theatre/browser-bundles@0.6.0-dev.4/dist/core-and-studio.js'
        const { core, studio } = Theatre

        const extensionConfig = {
            id: 'hello-world-extension',
            toolbars: {
                global(set, studio) {
                    set([
                        {
                            type: 'Icon',
                            title: 'HTML Export',
                            svgSource: '👁',
                            onClick: () => {
                                console.log(document.querySelector('html'));
                                console.log(canvas.getObjects())
                            }
                        },
                        {
                            type: 'Icon',
                            title: 'HTML Export',
                            svgSource: '👁',
                            onClick: () => {
                                console.log(document.querySelector('html'));
                                console.log(canvas.getObjects())
                            }
                        },
                    ])
                },
            },
            panes: [],
        }
        studio.extend(extensionConfig)
        studio.initialize();
        // studio.ui.hide()

        const project = core.getProject('HTML Animation Tutorial', { state: { "sheetsById": { "Sheet 1": { "staticOverrides": { "byObject": { "ccg_9": { "left": 614.41, "top": 66.45999999999998, "width": 297.99999, "angle": 0 } } } } }, "definitionVersion": "0.4.0", "revisionHistory": ["8SUIEFoQediM7AOe", "Lm3iAVueWJI9QQHU"] } })
        const sheet = project.sheet('Sheet 1')
        canvas.loadFromJSON(content, () => {

            const hexToRGB = hex => {
                const red = parseInt(hex.slice(1, 3), 16)
                const green = parseInt(hex.slice(3, 5), 16)
                const blue = parseInt(hex.slice(5, 7), 16)
                return { r: red / 255, g: green / 255, b: blue / 255, a: 1 } // return an object
                // return [ r, g, b ]
            }
            canvas.getObjects().forEach(element => {
                var obj = sheet.object(element.id, {
                    left: element.left,
                    top: element.top,
                    width: element.width,
                    height: element.height,
                    opacity: core.types.number(element.opacity, { nudgeMultiplier: 0.1 }),
                    scaleX: core.types.number(element.scaleX, { nudgeMultiplier: 0.01 }),
                    scaleY: core.types.number(element.scaleY, { nudgeMultiplier: 0.01 }),
                    angle: element.angle,
                    fill: core.types.rgba(hexToRGB(element.fill ? element.fill : '#ff0000')),
                    rx: core.types.number(element.rx ? element.rx : 10, { range: [0, 100] }),
                    ry: core.types.number(element.ry ? element.rx : 10, { range: [0, 100] }),
                    strokeWidth: core.types.number(element.strokeWidth, { range: [0, 100] }),
                    stroke: core.types.rgba(element.stroke ? hexToRGB(element.stroke) : hexToRGB('#000000')),
                    shadow: { ...shadowOptions, color: core.types.rgba(hexToRGB(element.shadow.color)), blur: core.types.number(parseInt(element.shadow.blur), { range: [0, 100] }) },
                    fontSize: core.types.number(element.fontSize ? parseInt(element.fontSize) : 30, { range: [0, 100] }),
                    strkdsar: core.types.number(element.strokeDashArray ? parseInt(element.strokeDashArray) : 0, { range: [0, 1000] }),
                    strkDsOfst: core.types.number(element.strokeDashOffset ? parseInt(element.strokeDashOffset) : 0, { range: [-1000, 1000] }),
                });

                var mouseDown = 0;
                document.body.onmousedown = function () {
                    mouseDown = 1;
                }
                document.body.onmouseup = function () {
                    mouseDown = 0;
                }

                const onMouseMove = (obj, event) => {
                    if (mouseDown === 1) {
                        studio.transaction(({ set }) => {
                            set(obj.props.left, event.target.left);
                            set(obj.props.top, event.target.top);
                            set(obj.props.width, event.target.width);
                            set(obj.props.angle, event.target.angle);
                        });
                    }

                };
                const onScaling = (obj, event) => {
                    // console.log(event)
                    studio.transaction(({ set }) => {
                        set(obj.props.scaleX, event.transform.target.scaleX);
                        set(obj.props.scaleY, event.transform.target.scaleY);
                    });
                };
                const onMousedblclick = (obj, event) => {
                    studio.transaction(({ unset }) => {
                        unset(obj.props);
                    });
                };


                element.on("mousedown", () => studio.setSelection([obj]), false);
                element.on("mousemove", (e) => onMouseMove(obj, e), false);
                element.on("scaling", (e) => onScaling(obj, e), false);
                element.on("mousedblclick", (e) => onMousedblclick(obj, e), false);

                obj.onValuesChange((obj) => {
                    element.set({
                        left: obj.left,
                        top: obj.top,
                        width: obj.width,
                        height: obj.height,
                        opacity: obj.opacity,
                        scaleX: obj.scaleX,
                        scaleY: obj.scaleY,
                        angle: obj.angle,
                        fill: obj.fill,
                        rx: obj.rx,
                        ry: obj.ry,
                        strokeWidth: obj.strokeWidth,
                        stroke: obj.stroke,
                        shadow: obj.shadow,
                        fontSize: obj.fontSize,
                        strokeDashArray: [obj.strkdsar, obj.strkdsar],
                        strokeDashOffset: obj.strkDsOfst
                    });
                    element.setCoords();
                    canvas.requestRenderAll();
                });
            })
        });
        project.ready.then(() => {
            sheet.sequence.play({ iterationCount: Infinity, range: [0, 2] })
        })
    </script>
</body>

</html>